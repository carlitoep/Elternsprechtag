<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Terminbuchung</title>
    <link rel="stylesheet" href="style.css" />
    <script>
      let lehrerName = localStorage.getItem("lehrerName");

      window.onload = function () {
        let formData2 = new URLSearchParams();
        formData2.append("lehrername", lehrerName);
        fetch("http://localhost:8080/api/raum", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData2,
        })
          .then((response) => response.text())
          .then((data) => {
            console.log(data);
            document.getElementById("info").innerText =
              "Termine von " + lehrerName + " in Raum " + data;
          })
          .catch((error) => console.error("Fehler:", error));

        let formData = new URLSearchParams();
        formData.append("lehrername", lehrerName);

        fetch("http://localhost:8080/api/lehrer", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData,
        })
          .then((response) => response.text())
          .then((data) => {
            let array = JSON.parse(data);
            for (let element of array) {
              let stelle = array.indexOf(element);
              let p = document.createElement("p");
              let div = document.createElement("div");
              div.classList.add("termin-box2");
              div.id = element;
              p.innerText = element;
              let container = document.getElementById("container");
              container.appendChild(div);
              div.appendChild(p);
              let teile = element.split(":");
              if (teile[2] == "frei") {
                div.style.backgroundColor = "green";
              } else {
                löschbar(stelle, array, `${teile[0]}:${teile[1]}`, teile[2]);
              }
            }
          })
          .catch((error) => console.error("Fehler:", error));
      };

      function zeitÄndern() {
        let anfang = document.getElementById("anfang").value;
        let ende = document.getElementById("ende").value;
        console.log(anfang);
        console.log(ende);
        console.log(anfang.split(":"));
        console.log(ende.split(":"));
        let formData = new URLSearchParams();
        formData.append("lehrername", lehrerName);
        formData.append("anfangS", anfang.split(":")[0]);
        formData.append("endeS", ende.split(":")[0]);
        formData.append("anfangM", anfang.split(":")[1]);
        formData.append("endeM", ende.split(":")[1]);

        fetch("http://localhost:8080/api/zeitenAendern", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData,
        })
          .then((response) => response.text())
          .then((data) => {
            console.log(data);
            document
              .querySelectorAll(".termin-box2")
              .forEach((element) => element.remove());
            let array = JSON.parse(data);
            for (let element of array) {
              let stelle = array.indexOf(element);
              let p = document.createElement("p");
              let div = document.createElement("div");
              div.classList.add("termin-box2");
              div.id = element;
              p.innerText = element;
              let container = document.getElementById("container");
              container.appendChild(div);
              div.appendChild(p);
              let teile = element.split(":");
              if (teile[2] == "frei") {
                div.style.backgroundColor = "green";
              } else {
                console.log(teile[2]);
                löschbar(stelle, array, `${teile[0]}:${teile[1]}`, teile[2]);
              }
            }
            window.location.href = "lehrerZeiten.html";
          });
      }

      function vorbuchen() {
        let name = document.getElementById("name").value;
        let uhrzeit = document.getElementById("uhrzeit").value;

        let formData = new URLSearchParams();
        formData.append("name", name);
        formData.append("lehrername", lehrerName);
        formData.append("urzeit", uhrzeit);

        fetch("http://localhost:8080/api/buchen", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData,
        })
          .then((response) => response.text())
          .then((data) => {
            console.log(data);
            alert(data); // Antwort vom Server anzeigen
            window.location.href = "lehrerZeiten.html";
          })
          .catch((error) => console.error("Fehler:", error));
      }

      function löschbar(stelle, zeitenArray, uhrzeit, name) {
        let lehrer =
          localStorage.getItem("lehrer").split(" ")[0] +
          " " +
          localStorage.getItem("lehrer").split(" ")[1];
        let formData = new URLSearchParams();
        formData.append("name", name);
        formData.append("lehrername", lehrer);
        formData.append("uhrzeit", uhrzeit);
        fetch("http://localhost:8080/api/loeschenmoeglich", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData,
        })
          .then((response) => response.text())
          .then((data) => {
            console.log(data);
            console.log("stelle:" + stelle);
            console.log("name:" + name);
            console.log("lehrer:" + lehrer);
            console.log("lehrer:" + uhrzeit);
            if (data == "löschbar") {
              let button = document.createElement("button");
              button.textContent = "Termin löschen";
              button.onclick = function () {
                löscheTermin(stelle, uhrzeit, name);
              };
              document.getElementById(zeitenArray[stelle]).appendChild(button);
            }
          })
          .catch((error) => console.error("Fehler:", error));
      }

      function löscheTermin(stelle, uhrzeit, name) {
        let formData = new URLSearchParams();
        let lehrer =
          localStorage.getItem("lehrer").split(" ")[0] +
          " " +
          localStorage.getItem("lehrer").split(" ")[1];
        formData.append("name", name);
        formData.append("lehrername", lehrer);
        formData.append("uhrzeit", uhrzeit);
        fetch("http://localhost:8080/api/loeschen", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData,
        })
          .then((response) => response.text())
          .then((data) => {
            alert(data);
            window.location.href = "lehrerZeiten.html";
          })
          .catch((error) => console.error("Fehler:", error));
      }
    </script>
  </head>
  <body>
    <div id="container" class="container">
      <p id="info"></p>
      <label for="Zeit">Zeit begrenzen</label>
      <input type="text" id="anfang" placeholder="Anfangszeit(XX:XX)" />
      <input type="text" id="ende" placeholder="Endzeit(XX:XX)" />
      <button onclick="zeitÄndern()">Zeiten ändern</button>
      <label for="Termin">Zeiten vorbuchen</label>
      <input type="text" id="name" placeholder="Vorname, Nachname" />
      <input type="text" id="uhrzeit" placeholder="Zeit(XX:XX)" />
      <button onclick="vorbuchen()">vorbuchen</button>
    </div>
  </body>
</html>
